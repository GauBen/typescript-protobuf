<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Protobuf Chat</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <h1>Protobuf Chat</h1>
    <div id="login">
      <form>
        <p>
          <label>Username: <input type="text" required /></label>
        </p>
        <p>
          <button type="submit">Join</button>
        </p>
      </form>
    </div>
    <div id="chat" hidden>
      <section></section>
      <form>
        <input type="text" required />
        <button type="submit">Send</button>
      </form>
    </div>
    <script>
      const $login = document.querySelector("#login");
      const $chat = document.querySelector("#chat");
      let username = "";

      const $loginForm = $login.querySelector("form");
      $loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        username = $loginForm.querySelector("input").value;
        $login.hidden = true;
        $chat.hidden = false;

        const source = new EventSource(`/messages?username=${username}`);
        source.addEventListener("message", (event) => {
          const message = JSON.parse(event.data);
          const $message = document.createElement("article");
          $message.innerHTML = `<strong>${message.username}</strong>: ${message.body}`;
          const $section = $chat.querySelector("section");
          $section.append($message);
          $section.scrollTop = $section.scrollHeight;
        });
        source.addEventListener("join", (event) => {
          const $message = document.createElement("div");
          $message.innerHTML = `<strong>${event.data}</strong> joined the chat`;
          const $section = $chat.querySelector("section");
          $section.append($message);
          $section.scrollTop = $section.scrollHeight;
        });
        source.addEventListener("leave", (event) => {
          const $message = document.createElement("div");
          $message.innerHTML = `<strong>${event.data}</strong> left the chat`;
          const $section = $chat.querySelector("section");
          $section.append($message);
          $section.scrollTop = $section.scrollHeight;
        });
      });

      const $chatForm = $chat.querySelector("form");
      $chatForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const body = $chatForm.querySelector("input").value;
        await fetch("/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, body }),
        });
        $chatForm.reset();
      });
    </script>
  </body>
</html>
